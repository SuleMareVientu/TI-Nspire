CFLAGS := -Wall -Werror -O3 -marm -mcpu=arm926ej-s -nostdlib -nostartfiles -s -ffreestanding -fno-builtin -std=gnu11 -fomit-frame-pointer -fPIE
LDFLAGS = --nostdlib -T ldscript -flto


OBJS = $(patsubst %.c, %.o, $(wildcard *.c))
OBJS += $(patsubst %.cpp, %.o, $(wildcard *.cpp))
OBJS += $(patsubst %.S, %.o, $(wildcard *.S))

all: loader.bin

%.o: %.S
	arm-none-eabi-gcc -c $^ -o $@

%.o: %.c
	arm-none-eabi-gcc -c $^ -o $@ $(CFLAGS)

loader.elf: $(OBJS)
	arm-none-eabi-ld $(LDFLAGS) libgcc/*.o $^ -o $@

loader.bin: loader.elf
	arm-none-eabi-objcopy -O binary $^ $@
	rm -f loader.elf $(OBJS)

clean:
	rm -f loader.bin loader.elf $(OBJS)

.PHONY: clean
